<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPACK ìˆ˜ì—… ì„¤ê³„ ì „ë¬¸ ì»¨ì„¤í„´íŠ¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-group label {
            display: block;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #333;
        }

        .input-group input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-group input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .checkbox-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            font-weight: normal;
            margin: 0;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-section {
            display: none;
            margin-top: 30px;
        }

        .result-section.active {
            display: block;
        }

        .result-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #e0e0e0;
        }

        .result-content h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .result-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .result-content table th,
        .result-content table td {
            padding: 15px;
            border: 1px solid #ddd;
            text-align: left;
            vertical-align: top;
        }

        .result-content table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        .result-content table td {
            background: white;
        }

        .result-content h3 {
            color: #764ba2;
            margin-top: 30px;
            margin-bottom: 15px;
        }

        .result-content blockquote {
            border-left: 4px solid #667eea;
            padding-left: 20px;
            margin: 20px 0;
            color: #666;
            font-style: italic;
        }

        .error-message {
            display: none;
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 2px solid #fcc;
        }

        .error-message.active {
            display: block;
        }

        .reset-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
        }

        .reset-btn:hover {
            background: #5a6268;
        }

        /* API í‚¤ ì…ë ¥ í™”ë©´ ìŠ¤íƒ€ì¼ */
        .api-key-section {
            display: none;
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .api-key-section.active {
            display: block;
        }

        .api-key-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }

        .api-key-section p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .api-key-section .info-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .api-key-section .info-box strong {
            color: #667eea;
        }

        .api-key-section input[type="password"],
        .api-key-section input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }

        .api-key-section input[type="password"]:focus,
        .api-key-section input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .api-key-section .toggle-visibility {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .api-key-section .toggle-visibility:hover {
            background: #5a6268;
        }

        .api-key-section .save-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .api-key-section .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .main-content {
            display: none;
        }

        .main-content.active {
            display: block;
        }

        .tpack-section {
            display: block;
        }

        .api-key-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            z-index: 1000;
            transition: background 0.3s;
        }

        .api-key-badge:hover {
            background: rgba(102, 126, 234, 1);
        }

        /* ì§„ë³´ì  íƒêµ¬í™œë™ ë²„íŠ¼ */
        .inquiry-badge {
            position: fixed;
            top: 70px;
            right: 20px;
            background: rgba(118, 75, 162, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            z-index: 1000;
            transition: background 0.3s;
        }

        .inquiry-badge:hover {
            background: rgba(118, 75, 162, 1);
        }

        /* ì§„ë³´ì  íƒêµ¬í™œë™ ì„¹ì…˜ */
        .inquiry-section {
            display: none;
        }

        .inquiry-section.active {
            display: block;
        }

        .inquiry-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 900px;
            margin: 0 auto;
        }

        .inquiry-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .inquiry-header h2 {
            color: #764ba2;
            margin-bottom: 10px;
        }

        .inquiry-chat {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
        }

        .chat-message.system {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .chat-message.user {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
            text-align: right;
        }

        .chat-message strong {
            display: block;
            margin-bottom: 5px;
            color: #333;
        }

        .inquiry-input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .inquiry-input-area input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .inquiry-input-area input:focus {
            outline: none;
            border-color: #764ba2;
        }

        .inquiry-input-area button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .inquiry-input-area button:hover {
            transform: translateY(-2px);
        }

        .inquiry-input-area button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .inquiry-report {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 10px;
            border: 2px solid #764ba2;
            margin-top: 20px;
        }

        .inquiry-report.active {
            display: block;
        }

        .inquiry-report h3 {
            color: #764ba2;
            margin-bottom: 15px;
        }

        .inquiry-report-item {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .inquiry-report-item strong {
            color: #764ba2;
            display: block;
            margin-bottom: 5px;
        }

        .step-indicator {
            display: inline-block;
            background: #764ba2;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- API í‚¤ ë°°ì§€ (ë©”ì¸ í™”ë©´ì—ì„œë§Œ í‘œì‹œ) -->
    <div class="api-key-badge" id="apiKeyBadge" style="display: none;" onclick="showApiKeySection()">
        ğŸ”‘ API í‚¤ ë³€ê²½
    </div>

    <!-- ì§„ë³´ì  íƒêµ¬í™œë™ ë²„íŠ¼ (TPACK í™”ë©´ì—ì„œë§Œ í‘œì‹œ) -->
    <div class="inquiry-badge" id="inquiryBadge" style="display: none;" onclick="showInquirySection()">
        ğŸ”¬ ì§„ë³´ì  íƒêµ¬í™œë™
    </div>

    <!-- TPACK ìˆ˜ì—… ì„¤ê³„ ë²„íŠ¼ (ì§„ë³´ì  íƒêµ¬í™œë™ í™”ë©´ì—ì„œë§Œ í‘œì‹œ) -->
    <div class="api-key-badge" id="tpackBadge" style="display: none; top: 70px; right: 20px;" onclick="showTpackSection()">
        ğŸ« TPACK ìˆ˜ì—… ì„¤ê³„
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸ« TPACK ìˆ˜ì—… ì„¤ê³„ ì „ë¬¸ ì»¨ì„¤í„´íŠ¸</h1>
            <p>ëŒ€í•œë¯¼êµ­ ì„ ìƒë‹˜ë“¤ì˜ ìˆ˜ì—… ê³ ë¯¼ì„ í•´ê²°í•´ë“œë¦½ë‹ˆë‹¤</p>
        </div>

        <!-- API í‚¤ ì…ë ¥ ì„¹ì…˜ -->
        <div class="content">
            <div class="api-key-section" id="apiKeySection">
                <h2>ğŸ”‘ Google AI Studio API í‚¤ ì„¤ì •</h2>
                <div class="info-box">
                    <strong>ğŸ“Œ ì•ˆë‚´:</strong> ì´ í”„ë¡œê·¸ë¨ì€ Google AI Studio(Gemini) APIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. 
                    API í‚¤ëŠ” ë¸Œë¼ìš°ì €ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ë©°, ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                </div>
                <p>
                    <strong>API í‚¤ ë°œê¸‰ ë°©ë²•:</strong><br>
                    1. <a href="https://aistudio.google.com/apikey" target="_blank">Google AI Studio</a>ì— ì ‘ì†<br>
                    2. Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸<br>
                    3. "Create API Key" ë²„íŠ¼ í´ë¦­í•˜ì—¬ ìƒˆ API í‚¤ ìƒì„±<br>
                    4. ìƒì„±ëœ í‚¤ë¥¼ ì•„ë˜ì— ì…ë ¥í•˜ì„¸ìš”
                </p>
                <form id="apiKeyForm">
                    <div class="input-group">
                        <label for="apiKey">Google AI Studio API í‚¤</label>
                        <input type="password" id="apiKey" name="apiKey" 
                               placeholder="AIza..." required>
                        <button type="button" class="toggle-visibility" onclick="toggleApiKeyVisibility()">
                            ğŸ‘ï¸ í‘œì‹œ/ìˆ¨ê¸°ê¸°
                        </button>
                    </div>
                    <button type="submit" class="save-btn">âœ… API í‚¤ ì €ì¥í•˜ê³  ì‹œì‘í•˜ê¸°</button>
                </form>
            </div>

            <!-- ë©”ì¸ ì½˜í…ì¸  -->
            <div class="main-content" id="mainContent">
            <!-- TPACK ìˆ˜ì—… ì„¤ê³„ ì„¹ì…˜ -->
            <div class="tpack-section" id="tpackSection">
            <div class="input-section" id="inputSection">
                <h2 style="margin-bottom: 20px; color: #333;">ğŸ“ ì…ë ¥ ê°€ì´ë“œ</h2>
                <p style="margin-bottom: 25px; color: #666; font-size: 1.05em;">
                    <strong>ì„ ìƒë‹˜, TPACK ìˆ˜ì—… ì„¤ê³„ë¥¼ ìœ„í•´ ì•„ë˜ 3ê°€ì§€ í•­ëª©ì„ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•´ ì£¼ì„¸ìš”.</strong>
                </p>

                <form id="lessonPlanForm">
                    <!-- 1. ìˆ˜ì—… ì£¼ì œ ë° ëŒ€ìƒ -->
                    <div class="input-group">
                        <label for="subject">1. ìˆ˜ì—… ì£¼ì œ ë° ëŒ€ìƒ (ì§ì ‘ ì…ë ¥)</label>
                        <input type="text" id="subject" name="subject" 
                               placeholder="ì˜ˆ: ì´ˆ5 ê³¼í•™ - íƒœì–‘ê³„, ê³ 2 ë¬¸í•™ - ê´€ë™ë³„ê³¡" required>
                    </div>

                    <!-- 2. ì„ í˜¸í•˜ëŠ” ìˆ˜ì—… ë°©ì‹ (P) -->
                    <div class="input-group">
                        <label>2. ì„ í˜¸í•˜ëŠ” ìˆ˜ì—… ë°©ì‹ (P) [ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥]</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="method1" name="teachingMethods" value="1">
                                <label for="method1">(1) ê°•ì˜ ë° ê°œë… ì„¤ëª…</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="method2" name="teachingMethods" value="2">
                                <label for="method2">(2) íƒêµ¬ ë° í”„ë¡œì íŠ¸</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="method3" name="teachingMethods" value="3">
                                <label for="method3">(3) í† ì˜ ë° í† ë¡ </label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="method4" name="teachingMethods" value="4">
                                <label for="method4">(4) í˜‘ë ¥ ë° ë™ë£Œ í•™ìŠµ</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="method5" name="teachingMethods" value="5">
                                <label for="method5">(5) ê²Œì„ ë° í€´ì¦ˆ</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="method6" name="teachingMethods" value="6">
                                <label for="method6">(6) ì§ì ‘ ì…ë ¥</label>
                            </div>
                        </div>
                        <input type="text" id="methodCustom" name="methodCustom" 
                               placeholder="ì§ì ‘ ì…ë ¥ (ì˜ˆ: ê±°ê¾¸ë¡œ ìˆ˜ì—…, ì—­í• ê·¹ ë“±)" 
                               style="margin-top: 10px; display: none;">
                    </div>

                    <!-- 3. ê¸°ìˆ  ë° ë„êµ¬ í™˜ê²½ (T) -->
                    <div class="input-group">
                        <label>3. ê¸°ìˆ  ë° ë„êµ¬ í™˜ê²½ (T) [ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥]</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="toolA" name="techTools" value="A">
                                <label for="toolA">(A) í•™ìƒ 1ì¸ 1ê¸°ê¸°</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="toolB" name="techTools" value="B">
                                <label for="toolB">(B) ëª¨ë‘ ë³„ ê¸°ê¸° ì‚¬ìš©</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="toolC" name="techTools" value="C">
                                <label for="toolC">(C) êµì‚¬ë§Œ ê¸°ê¸° ì‚¬ìš©</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="toolD" name="techTools" value="D">
                                <label for="toolD">(D) ì•„ë‚ ë¡œê·¸ í˜¼í•©</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="toolE" name="techTools" value="E">
                                <label for="toolE">(E) íŠ¹ì • ë„êµ¬ í¬ë§</label>
                            </div>
                        </div>
                        <input type="text" id="toolCustom" name="toolCustom" 
                               placeholder="ì§ì ‘ ì…ë ¥ (ì˜ˆ: íŒ¨ë“¤ë ›, ìº”ë°”, ëµì»¤ë²¨, AIì½”ìŠ¤ì›¨ì–´ ë“±)" 
                               style="margin-top: 10px; display: none;">
                    </div>

                    <button type="submit" class="submit-btn" id="submitBtn">
                        âœ¨ ìˆ˜ì—… ì„¤ê³„ì•ˆ ìƒì„±í•˜ê¸°
                    </button>
                </form>

                <div class="error-message" id="errorMessage"></div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="font-size: 1.1em; color: #667eea;">ìˆ˜ì—… ì„¤ê³„ì•ˆì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                <p style="color: #999; margin-top: 10px;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
            </div>

            <div class="result-section" id="resultSection">
                <div class="result-content" id="resultContent"></div>
                <button class="reset-btn" onclick="resetForm()">ğŸ”„ ìƒˆë¡œ ì‘ì„±í•˜ê¸°</button>
            </div>
            </div>

            <!-- ì§„ë³´ì  íƒêµ¬í™œë™ ì„¹ì…˜ -->
            <div class="inquiry-section" id="inquirySection">
                <div class="inquiry-container">
                    <div class="inquiry-header">
                        <h2>ğŸ”¬ ì§„ë³´ì  íƒêµ¬ ëª¨ë¸ ì‹¤ìŠµ</h2>
                        <p>ì§ˆë¬¸ì´ ì´ë„ëŠ” í•™ìŠµì„ ê²½í—˜í•´ë³´ì„¸ìš”</p>
                    </div>

                    <div class="inquiry-chat" id="inquiryChat">
                        <!-- ëŒ€í™” ë‚´ìš©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>

                    <div class="inquiry-input-area" id="inquiryInputArea">
                        <input type="text" id="inquiryInput" placeholder="ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”..." disabled>
                        <button id="inquirySubmitBtn" onclick="handleInquiryInput()" disabled>ì „ì†¡</button>
                    </div>

                    <div class="inquiry-report" id="inquiryReport">
                        <h3>ğŸ“‹ ì§„ë³´ì  íƒêµ¬ ë³´ê³ ì„œ</h3>
                        <div id="inquiryReportContent"></div>
                        <button class="reset-btn" onclick="resetInquiry()" style="margin-top: 20px;">ğŸ”„ ìƒˆë¡œ ì‹œì‘í•˜ê¸°</button>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>

    <script>
        // API í‚¤ ê´€ë¦¬
        const API_KEY_STORAGE = 'tpack_google_ai_api_key';

        // í˜ì´ì§€ ë¡œë“œ ì‹œ API í‚¤ í™•ì¸ ë° ì„œë²„ ì—°ê²° í™•ì¸
        window.addEventListener('DOMContentLoaded', function() {
            // file:// í”„ë¡œí† ì½œë¡œ ì—´ë ¸ëŠ”ì§€ í™•ì¸
            if (window.location.protocol === 'file:') {
                alert('âš ï¸ ì„œë²„ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!\n\n' +
                      'ì´ í”„ë¡œê·¸ë¨ì€ ì„œë²„ë¥¼ í†µí•´ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.\n\n' +
                      'í•´ê²° ë°©ë²•:\n' +
                      '1. í„°ë¯¸ë„(ëª…ë ¹ í”„ë¡¬í”„íŠ¸)ì„ ì—´ê³ \n' +
                      '2. í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™í•œ í›„\n' +
                      '3. "npm start" ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”\n' +
                      '4. ê·¸ ë‹¤ìŒ http://localhost:3000 ìœ¼ë¡œ ì ‘ì†í•˜ì„¸ìš”\n\n' +
                      'HTML íŒŒì¼ì„ ì§ì ‘ ì—´ì§€ ë§ˆì„¸ìš”!');
                return;
            }

            const savedApiKey = localStorage.getItem(API_KEY_STORAGE);
            if (savedApiKey) {
                showMainContent();
            } else {
                showApiKeySection();
            }
        });

        function showApiKeySection() {
            document.getElementById('apiKeySection').classList.add('active');
            document.getElementById('mainContent').classList.remove('active');
            document.getElementById('apiKeyBadge').style.display = 'none';
            // ì €ì¥ëœ API í‚¤ê°€ ìˆìœ¼ë©´ ì…ë ¥ í•„ë“œì— í‘œì‹œ
            const savedApiKey = localStorage.getItem(API_KEY_STORAGE);
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
            }
        }

        function showMainContent() {
            document.getElementById('apiKeySection').classList.remove('active');
            document.getElementById('mainContent').classList.add('active');
            document.getElementById('apiKeyBadge').style.display = 'block';
            showTpackSection(); // ê¸°ë³¸ì ìœ¼ë¡œ TPACK ì„¹ì…˜ í‘œì‹œ
        }

        function showTpackSection() {
            document.getElementById('tpackSection').style.display = 'block';
            document.getElementById('inquirySection').classList.remove('active');
            document.getElementById('apiKeyBadge').style.display = 'block';
            document.getElementById('inquiryBadge').style.display = 'block';
            document.getElementById('tpackBadge').style.display = 'none';
        }

        function showInquirySection() {
            document.getElementById('tpackSection').style.display = 'none';
            document.getElementById('inquirySection').classList.add('active');
            document.getElementById('apiKeyBadge').style.display = 'none';
            document.getElementById('inquiryBadge').style.display = 'none';
            document.getElementById('tpackBadge').style.display = 'block';
            // ì§„ë³´ì  íƒêµ¬í™œë™ ì‹œì‘
            if (!window.inquiryStarted) {
                startInquiry();
            }
        }

        function toggleApiKeyVisibility() {
            const apiKeyInput = document.getElementById('apiKey');
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
            } else {
                apiKeyInput.type = 'password';
            }
        }

        // API í‚¤ í¼ ì œì¶œ
        document.getElementById('apiKeyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!apiKey) {
                alert('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!apiKey.startsWith('AIza')) {
                if (!confirm('ì…ë ¥í•˜ì‹  í‚¤ê°€ Google AI Studio API í‚¤ í˜•ì‹ì´ ì•„ë‹Œ ê²ƒ ê°™ìŠµë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }
            }

            // API í‚¤ ì €ì¥
            localStorage.setItem(API_KEY_STORAGE, apiKey);
            showMainContent();
        });

        // ì €ì¥ëœ API í‚¤ ê°€ì ¸ì˜¤ê¸°
        function getApiKey() {
            return localStorage.getItem(API_KEY_STORAGE);
        }
        // ì§ì ‘ ì…ë ¥ ì²´í¬ë°•ìŠ¤ ì²˜ë¦¬
        document.getElementById('method6').addEventListener('change', function() {
            document.getElementById('methodCustom').style.display = this.checked ? 'block' : 'none';
        });

        document.getElementById('toolE').addEventListener('change', function() {
            document.getElementById('toolCustom').style.display = this.checked ? 'block' : 'none';
        });

        // í¼ ì œì¶œ ì²˜ë¦¬
        document.getElementById('lessonPlanForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // ì…ë ¥ê°’ ìˆ˜ì§‘
            const subject = document.getElementById('subject').value.trim();
            const teachingMethods = Array.from(document.querySelectorAll('input[name="teachingMethods"]:checked'))
                .map(cb => cb.value);
            const techTools = Array.from(document.querySelectorAll('input[name="techTools"]:checked'))
                .map(cb => cb.value);

            // ì§ì ‘ ì…ë ¥ ì²˜ë¦¬
            const methodCustom = document.getElementById('methodCustom').value.trim();
            if (methodCustom && teachingMethods.includes('6')) {
                teachingMethods[teachingMethods.indexOf('6')] = methodCustom;
            }

            const toolCustom = document.getElementById('toolCustom').value.trim();
            if (toolCustom && techTools.includes('E')) {
                techTools[techTools.indexOf('E')] = toolCustom;
            }

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!subject) {
                showError('ìˆ˜ì—… ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (teachingMethods.length === 0) {
                showError('ìµœì†Œ 1ê°œ ì´ìƒì˜ ìˆ˜ì—… ë°©ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (techTools.length === 0) {
                showError('ìµœì†Œ 1ê°œ ì´ìƒì˜ ê¸°ìˆ  ë„êµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('inputSection').style.display = 'none';
            document.getElementById('resultSection').classList.remove('active');
            document.getElementById('loading').classList.add('active');
            document.getElementById('errorMessage').classList.remove('active');
            document.getElementById('submitBtn').disabled = true;

            // API í‚¤ í™•ì¸
            const apiKey = getApiKey();
            if (!apiKey) {
                showError('API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                showApiKeySection();
                document.getElementById('inputSection').style.display = 'block';
                document.getElementById('loading').classList.remove('active');
                document.getElementById('submitBtn').disabled = false;
                return;
            }

            try {
                // ì„œë²„ ì—°ê²° í™•ì¸ (file:// í”„ë¡œí† ì½œ ì²´í¬)
                if (window.location.protocol === 'file:') {
                    throw new Error('ì„œë²„ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í„°ë¯¸ë„ì—ì„œ "npm start" ëª…ë ¹ì–´ë¡œ ì„œë²„ë¥¼ ì‹¤í–‰í•œ í›„ http://localhost:3000 ìœ¼ë¡œ ì ‘ì†í•´ì£¼ì„¸ìš”.');
                }

                // API í˜¸ì¶œ
                const response = await fetch('/api/generate-lesson-plan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        subject,
                        teachingMethods,
                        techTools,
                        apiKey: apiKey
                    })
                });

                // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì²˜ë¦¬
                if (!response) {
                    throw new Error('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”. (npm start)');
                }

                const data = await response.json();

                if (!response.ok) {
                    let errorMessage = data.error || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    if (data.details) {
                        errorMessage += '\n\nìƒì„¸ ì˜¤ë¥˜: ' + data.details;
                    }
                    throw new Error(errorMessage);
                }

                // ê²°ê³¼ í‘œì‹œ
                displayResult(data.lessonPlan);

            } catch (error) {
                console.error('Error:', error);
                
                // CORS ì˜¤ë¥˜ë‚˜ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì¸ ê²½ìš° ë” ëª…í™•í•œ ë©”ì‹œì§€ í‘œì‹œ
                let errorMessage = error.message || 'ìˆ˜ì—… ì„¤ê³„ì•ˆ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                
                if (error.message.includes('Failed to fetch') || 
                    error.message.includes('CORS') || 
                    error.message.includes('network')) {
                    errorMessage = 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\n' +
                                  'í•´ê²° ë°©ë²•:\n' +
                                  '1. í„°ë¯¸ë„ì—ì„œ "npm start" ëª…ë ¹ì–´ ì‹¤í–‰\n' +
                                  '2. ë¸Œë¼ìš°ì €ì—ì„œ http://localhost:3000 ìœ¼ë¡œ ì ‘ì†\n' +
                                  '3. HTML íŒŒì¼ì„ ì§ì ‘ ì—´ì§€ ë§ˆì„¸ìš”!';
                }
                
                showError(errorMessage);
                document.getElementById('inputSection').style.display = 'block';
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('submitBtn').disabled = false;
            }
        });

        function displayResult(lessonPlan) {
            const resultContent = document.getElementById('resultContent');
            
            // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜
            let html = lessonPlan;
            
            // í‘œ ì²˜ë¦¬ (ë§ˆí¬ë‹¤ìš´ í‘œë¥¼ HTML í‘œë¡œ ë³€í™˜)
            const tableRegex = /(\|.+\|(?:\n\|.+\|)*)/g;
            html = html.replace(tableRegex, function(match) {
                const lines = match.trim().split('\n');
                let tableHtml = '<table>';
                let isFirstRow = true;
                
                lines.forEach((line, index) => {
                    // êµ¬ë¶„ì„  í–‰ì€ ê±´ë„ˆë›°ê¸°
                    if (line.includes('---')) {
                        return;
                    }
                    
                    const cells = line.split('|').map(c => c.trim()).filter(c => c);
                    if (cells.length === 0) return;
                    
                    const tag = isFirstRow ? 'th' : 'td';
                    tableHtml += '<tr>';
                    
                    cells.forEach(cell => {
                        // ë§ˆí¬ë‹¤ìš´ í¬ë§·íŒ… ì²˜ë¦¬
                        let cellContent = cell
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                            .replace(/\*(.*?)\*/g, '<em>$1</em>')
                            .replace(/âš ï¸/g, 'âš ï¸')
                            .replace(/\n/g, '<br>');
                        
                        tableHtml += `<${tag}>${cellContent}</${tag}>`;
                    });
                    
                    tableHtml += '</tr>';
                    isFirstRow = false;
                });
                
                tableHtml += '</table>';
                return tableHtml;
            });
            
            // ì œëª© ì²˜ë¦¬
            html = html.replace(/^## (.*)$/gm, '<h2>$1</h2>');
            html = html.replace(/^### (.*)$/gm, '<h3>$1</h3>');
            
            // ì¸ìš©êµ¬ ì²˜ë¦¬
            html = html.replace(/^> (.*)$/gm, '<blockquote>$1</blockquote>');
            
            // ë‚˜ë¨¸ì§€ ë§ˆí¬ë‹¤ìš´ í¬ë§·íŒ…
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // ë¬¸ë‹¨ ì²˜ë¦¬ (ì—°ì†ëœ ì¤„ë°”ê¿ˆì„ ë¬¸ë‹¨ìœ¼ë¡œ)
            html = html.split('\n\n').map(para => {
                para = para.trim();
                if (!para) return '';
                if (para.startsWith('<')) return para; // ì´ë¯¸ HTML íƒœê·¸
                return '<p>' + para.replace(/\n/g, '<br>') + '</p>';
            }).join('');

            resultContent.innerHTML = html;
            document.getElementById('resultSection').classList.add('active');
            document.getElementById('inputSection').style.display = 'none';
            
            // ê²°ê³¼ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            // ì¤„ë°”ê¿ˆì„ <br>ë¡œ ë³€í™˜
            errorDiv.innerHTML = message.replace(/\n/g, '<br>');
            errorDiv.classList.add('active');
            // ì˜¤ë¥˜ ë©”ì‹œì§€ë¡œ ìŠ¤í¬ë¡¤
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function resetForm() {
            document.getElementById('lessonPlanForm').reset();
            document.getElementById('methodCustom').style.display = 'none';
            document.getElementById('toolCustom').style.display = 'none';
            document.getElementById('inputSection').style.display = 'block';
            document.getElementById('resultSection').classList.remove('active');
            document.getElementById('errorMessage').classList.remove('active');
            document.getElementById('resultContent').innerHTML = '';
        }

        // ì§„ë³´ì  íƒêµ¬í™œë™ ê´€ë ¨ ë³€ìˆ˜
        let inquiryState = {
            step: 0, // 0: ì‹œì‘, 1: ì§ˆë¬¸, 2: ì„¤ëª…, 3: í™•ì¸, 4: í™•ì¥, 5: ì™„ë£Œ
            topic: '',
            question: '',
            explanation: '',
            unknowns: '',
            expandedQuestion: ''
        };

        // ì§„ë³´ì  íƒêµ¬í™œë™ ì‹œì‘
        function startInquiry() {
            window.inquiryStarted = true;
            inquiryState = {
                step: 0,
                topic: '',
                question: '',
                explanation: '',
                unknowns: '',
                expandedQuestion: ''
            };
            
            const chatArea = document.getElementById('inquiryChat');
            chatArea.innerHTML = '';
            
            addSystemMessage('ì„ ìƒë‹˜, ì•ˆë…•í•˜ì„¸ìš”! ì§„ë³´ì  íƒêµ¬ ëª¨ë¸ì„ ì‹¤ìŠµí•´ ë³´ê² ìŠµë‹ˆë‹¤. í•™ìƒë“¤ê³¼ íƒêµ¬í•´ë³´ê³  ì‹¶ì€ ì£¼ì œ(ì˜ˆ: ì‹ë¬¼ì€ ê°ê°ì´ ìˆì„ê¹Œ?, ì‚¼ê°í˜•ì˜ ë‚´ê°ì˜ í•©ì€ ì™œ 180ë„ì¼ê¹Œ?)ë¥¼ í•˜ë‚˜ë§Œ ë§ì”€í•´ ì£¼ì„¸ìš”.');
            
            document.getElementById('inquiryInput').disabled = false;
            document.getElementById('inquirySubmitBtn').disabled = false;
            document.getElementById('inquiryInput').focus();
            document.getElementById('inquiryReport').classList.remove('active');
        }

        // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì¶”ê°€
        function addSystemMessage(text) {
            const chatArea = document.getElementById('inquiryChat');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message system';
            messageDiv.innerHTML = `<strong>ğŸ”¬ íƒêµ¬ ì½”ì¹˜:</strong> ${text}`;
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        function addUserMessage(text) {
            const chatArea = document.getElementById('inquiryChat');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message user';
            messageDiv.innerHTML = `<strong>ğŸ‘¤ ì„ ìƒë‹˜:</strong> ${text}`;
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // ì§„ë³´ì  íƒêµ¬í™œë™ ì…ë ¥ ì²˜ë¦¬
        async function handleInquiryInput() {
            const input = document.getElementById('inquiryInput');
            const userInput = input.value.trim();
            
            if (!userInput) return;
            
            addUserMessage(userInput);
            input.value = '';
            input.disabled = true;
            document.getElementById('inquirySubmitBtn').disabled = true;
            
            try {
                if (inquiryState.step === 0) {
                    // 1ë‹¨ê³„: ì£¼ì œ ì„ ì •
                    inquiryState.topic = userInput;
                    inquiryState.step = 1;
                    addSystemMessage('ì¢‹ì€ ì£¼ì œì…ë‹ˆë‹¤! ì´ ì£¼ì œë¡œ íƒêµ¬ë¥¼ ì‹œì‘í•˜ê¸° ìœ„í•´ ê°€ì¥ ë¨¼ì € í•™ìƒë“¤ì—ê²Œ ë˜ì§ˆ ì§ˆë¬¸ì€ ë¬´ì—‡ì¸ê°€ìš”?');
                } else if (inquiryState.step === 1) {
                    // 2ë‹¨ê³„: ì§ˆë¬¸ ë˜ì§€ê¸°
                    inquiryState.question = userInput;
                    inquiryState.step = 2;
                    addSystemMessage('í›Œë¥­í•œ ì§ˆë¬¸ì…ë‹ˆë‹¤! ì´ì œ ì´ ì§ˆë¬¸ì— ëŒ€í•´ í•™ìƒë“¤ì´ë‚˜ ì¼ë°˜ì ì¸ ì‚¬ëŒë“¤ì´ ê°€ì§ˆ ë²•í•œ <strong>ì ì •ì ì¸ ì„¤ëª…(ê°€ì„¤)</strong>ì´ë‚˜ <strong>í˜„ì¬ ì•Œê³  ìˆëŠ” ì§€ì‹</strong>ì„ ì ì–´ë³´ì„¸ìš”. ì •ë‹µì„ ë°”ë¡œ ì°¾ëŠ” ê²Œ ì•„ë‹ˆë¼, ìì‹ ë§Œì˜ ì„¤ëª…ì„ ë§Œë“œëŠ” ê³¼ì •ì´ ì¤‘ìš”í•©ë‹ˆë‹¤.');
                } else if (inquiryState.step === 2) {
                    // 3ë‹¨ê³„: ì„¤ëª… ë§Œë“¤ê¸°
                    inquiryState.explanation = userInput;
                    inquiryState.step = 3;
                    
                    // AIë¥¼ ì‚¬ìš©í•˜ì—¬ í™•ì¸ ë° ëª¨ë¥¸í•˜ê¸° ë‹¨ê³„ ì§„í–‰
                    const apiKey = getApiKey();
                    if (!apiKey) {
                        addSystemMessage('API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. API í‚¤ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
                        input.disabled = false;
                        document.getElementById('inquirySubmitBtn').disabled = false;
                        return;
                    }
                    
                    addSystemMessage('ì ì‹œë§Œìš”, ì„¤ëª…ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
                    
                    const response = await fetch('/api/inquiry-check', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            topic: inquiryState.topic,
                            question: inquiryState.question,
                            explanation: userInput,
                            apiKey: apiKey
                        })
                    });
                    
                    const data = await response.json();
                    if (response.ok) {
                        inquiryState.unknowns = data.unknowns;
                        inquiryState.step = 4;
                        addSystemMessage(data.feedback);
                        addSystemMessage('ì´ì œ í™•ì¸ëœ ëª¨ë¥´ëŠ” ì ì„ í•´ê²°í•˜ê¸° ìœ„í•´, ì´ˆê¸° ì§ˆë¬¸ì„ ë” êµ¬ì²´ì ì´ê±°ë‚˜ ì‹¬í™”ëœ <strong>ìƒˆë¡œìš´ ì§ˆë¬¸</strong>ìœ¼ë¡œ ë°œì „ì‹œì¼œ ë³´ì„¸ìš”. ì´ê²ƒì´ ë°”ë¡œ ì§ˆë¬¸ì´ ì´ë„ëŠ” í•™ìŠµì˜ í•µì‹¬ì…ë‹ˆë‹¤.');
                    } else {
                        throw new Error(data.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                } else if (inquiryState.step === 4) {
                    // 4ë‹¨ê³„: ì§ˆë¬¸ í™•ì¥
                    inquiryState.expandedQuestion = userInput;
                    inquiryState.step = 5;
                    
                    // ë³´ê³ ì„œ ìƒì„±
                    generateInquiryReport();
                }
            } catch (error) {
                console.error('Error:', error);
                addSystemMessage('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
            
            if (inquiryState.step < 5) {
                input.disabled = false;
                document.getElementById('inquirySubmitBtn').disabled = false;
                input.focus();
            }
        }

        // Enter í‚¤ë¡œ ì „ì†¡
        document.getElementById('inquiryInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !this.disabled) {
                handleInquiryInput();
            }
        });

        // ì§„ë³´ì  íƒêµ¬ ë³´ê³ ì„œ ìƒì„±
        function generateInquiryReport() {
            const reportContent = document.getElementById('inquiryReportContent');
            reportContent.innerHTML = `
                <div class="inquiry-report-item">
                    <strong>1. ì´ˆê¸° ì§ˆë¬¸:</strong>
                    ${inquiryState.question}
                </div>
                <div class="inquiry-report-item">
                    <strong>2. ì ì •ì  ì„¤ëª…:</strong>
                    ${inquiryState.explanation}
                </div>
                <div class="inquiry-report-item">
                    <strong>3. íƒêµ¬ì˜ ë‹¨ì„œ(ëª¨ë¥´ëŠ” ê²ƒ):</strong>
                    ${inquiryState.unknowns}
                </div>
                <div class="inquiry-report-item">
                    <strong>4. í™•ì¥ëœ ì§ˆë¬¸:</strong>
                    ${inquiryState.expandedQuestion}
                </div>
                <div style="margin-top: 20px; padding: 15px; background: #f0f4ff; border-radius: 5px; border-left: 4px solid #667eea;">
                    <strong>ğŸ’¡ ì½”ë©˜íŠ¸:</strong> ì„ ìƒë‹˜, ì´ë ‡ê²Œ ì§ˆë¬¸ì´ ê¼¬ë¦¬ë¥¼ ë¬¼ê³  ì§€ì‹ì´ í™•ì¥ë˜ëŠ” ê³¼ì •ì„ í•™ìƒë“¤ê³¼ ê²½í—˜í•´ ë³´ì„¸ìš”!
                </div>
            `;
            
            document.getElementById('inquiryReport').classList.add('active');
            document.getElementById('inquiryInputArea').style.display = 'none';
            
            addSystemMessage('íƒêµ¬ ì‹¤ìŠµì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì•„ë˜ ë³´ê³ ì„œë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.');
        }

        // ì§„ë³´ì  íƒêµ¬í™œë™ ì´ˆê¸°í™”
        function resetInquiry() {
            window.inquiryStarted = false;
            document.getElementById('inquiryChat').innerHTML = '';
            document.getElementById('inquiryReport').classList.remove('active');
            document.getElementById('inquiryInputArea').style.display = 'flex';
            document.getElementById('inquiryInput').value = '';
            startInquiry();
        }
    </script>
</body>
</html>

